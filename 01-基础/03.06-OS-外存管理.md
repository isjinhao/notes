---
title: 06.06-OS-外存管理
tags:
  - 操作系统
  - 课内学习
categories:
  - 操作系统
mathjax: true
abbrlink: 43988
date: 2019-12-20 17:19:38
---
*外存管理分成两块，文件系统和磁盘管理*

<br>
## 文件管理概述

计算机中有很多的程序和数据都是保存在外存中，在需要使用的时候才调入内存中。而如何保存这些信息是很重要的问题，因为不同类型的文件存储的数据格式不同，但这些格式却必须“迎合”硬件只能存储二进制数据的硬性条件。所以操作系统提供了文件管理的功能，让使用者能在不了解文件特性和外存特性的情况下完成文件的存储和查找等功能。同时还提供了文件共享和安全管理等功能。

<br>
### 文件系统 & 文件

操作系统中负责管理和存储文件信息的软件称为文件管理系统，简称文件系统。包含：文件系统的接口，对对象操纵和管理的软件集合，对象及属性三部分。它负责对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。包含创建文件、删除文件等功能。
文件是指具有文件名的若干相关元素的集合，可以分成有结构文件和无结构文件，无结构文件可以看成一个字符流。有结构文件是由一组记录的集合，记录又是一组数据项的集合。
- 数据项：用来描述一个对象的某种属性的字符集。例如学生的学号、姓名等。
- 记录：一组数据项的集合，用来描述一个对象在某方面的属性，例如学生的成绩。能唯一标识一个记录的一个或多个数据项叫做关键字。

<br>
### 文件类型

不同的文件类型由于本身存储的信息具有不同的结构，在管理的时候也是不同。所以文件会被分成很多类型，下面是常用的文件分类方法：
- 按用途分类：系统文件、库文件、用户文件。
- 按文件中数据的形式分类：源文件、目标文件、可执行文件。
- 按存储控制属性分类：可读、可写、可执行文件。
- 按组织形式和处理方法分类：普通文件、目录文件、特殊文件。

<br>
### 剖析文件和目录

我们刚才在定义中说道，文件是指具有文件名的若干相关元素的集合，在有结构文件中这些元素是数据项集合的集合，在无结构文件指的是字符流。所以文件的概念中本身是：

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/48e07c68-5ff3-4076-9203-a310cb6e99e0" /></div>
<br>
## 文件系统的层次结构

文件系统从底层到高层可分成三部分：对象及其属性、对对象操纵和管理的软件集合、文件系统接口：

**对象及其属性**

文件管理系统管理的文件如下：
- 文件：在文件管理系统中有着各种不同类型的文件，它们都作为文件管理的直接对象。
- 目录：用于对文件的存储和检索，目录的每个目录项包含了一个文件或目录的信息。
- 磁盘存储空间：文件和目录必定占用存储空间，对这部分空间的有效管理不仅能提高外存的利用率，而且能提高对文件的存取速度。

**对对象操纵和管理的软件集合**

该层是文件管理系统的核心部分。文件系统的功能大多是在这一层实现的。如：文件存储的管理、文件目录的管理、将文件的逻辑地址转换为物理地址的机制、文件读写控制的管理、文件的共享和保护等功能。这些功能被可分为四层：
- I/O控制层：文件系统的最底层、主要由磁盘驱动程序等组成。
- 基本文件系统层：主要用于处理内存和磁盘之间数据块的交换。
- 基本I/O管理程序：完成与磁盘I/O有关的事务，如将文件的逻辑块号转换为物理块号、管理磁盘中的空闲盘块、I/O缓冲的指定等。
- 逻辑文件系统：管控对文件的操作，如控制用户或应用程序对文件的读写等。

**文件系统的接口**

操作系统提供给用户或应用程序用来使用文件系统的接口：
- 命令接口：用户与文件系统直接交互的接口，如Shell命令。
- 程序接口：应用程序可以通过一系列命令调用文件系统的服务。

<br>
## 文件的打开和关闭

当用户要求对一个文件实施多次读/写操作时，如果每次都检索目录效率较低，所以为了避免多次重复的检索目录，OS提供了“打开（Open）”操作，当此操作被执行时，OS会把被打开文件的信息存为“打开文件表”的一个条目，然后把这个条目编号返回用户，这样用户就可以通过这个编号和文件之间建立一个连接，也就可以进行文件的读写等操作。当用户再次向系统发出请求时，把这个编号提交给OS，OS通过这个编号在打开文件表中查找文件信息就可以减少检索时间。而关闭就是OS从“打开文件表”上删除此条目，这样断开了用户和文件之间的连接。

<br>
## 文件的逻辑结构和物理结构

- 逻辑结构：从用户的角度来看，文件是能被存取的基本单位。
- 物理结构：文件在磁盘上存储时的组织形式。

<br>
### 逻辑文件按结构分类

- 有结构文件：每个文件用于描述实体集中的一个实体。每个记录的长度对OS来说都是可知的。但记录之间可以分为定长和变长两种。
  - 定长记录：所有记录的长度都是相同的、所有记录中的各数据项都处在记录中相同的位置具有相同的顺序和长度。
  - 变长记录：各记录的长度不相同。比如论文的摘要可能长度差距很大，不能在存储之前估计出所需要的空间。
- 无结构文件：系统中运行的大量的源程序、可执行文件、文本文件等都是无结构文件，即流式文件。其文件长度是以字节为单位的。

<br>
### 逻辑文件按组织方式分类

组织方式指的是文件中记录的组织方式。只对有结构文件有效。可以分成：顺序文件、索引文件、索引顺序文件。

<br>
### 顺序文件

指由一系列记录按某种顺序排列所形成的的文件。
- 串结构：按存入时间的先后顺序排列。所以检索时必须从头挨个查找，效率低。
- 顺序结构：用户指定一个字段作为关键字，他可以是任意类型的变量。如sql文件。

<br>
### 索引文件

为变长记录文件创建一张索引表，索引表是定长记录文件，检索时，先查找索引表，再根据指针所指的地址读取记录。可以解决变长文件记录较难直接存取的问题。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/453ddfa5-648b-4d80-a82f-8c23075d486e" /></div>
<br>
### 索引顺序文件

将顺序文件的所有记录分成若干组，为顺序文件建立一张索引表，索引表中为每组的第一个记录建立一个索引项。检索时，先检索索引表，找到记录所在记录组的第一个记录的表项，再顺序查找主文件，得到要求的记录。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/e955a679-4e9f-47fe-a922-5c340b31e898" /></div>
<br>
## 文件目录


### 文件控制块

包含三类信息
- 基本信息类：文件名、文件物理位置、文件逻辑结构、文件物理结构
- 控制信息类：各类用户的读、写、可执行文件等。
- 使用信息类：文件的建立时间，当前的使用信息，上一次修改的时间，是否被进程锁住等。

<br>
### 索引节点

为了唯一确定外存中的一个文件，必须要把文件的FCB加载进内存，而每次加载的数据大小是一定的，所以为了一次能多加载进内存一个文件标识。将FCB分成两部分：

#### 磁盘索引节点

- 文件主标识符
- 文件类型
- 文件存取权限
- 文件物理地址
- 文件长度
- 文件连接计数：本人理解为硬链接计数
- 文件存取时间

#### 内存索引节点。

- 索引节点编号
- 状态
- 访问计数
- 文件所属文件系统的逻辑设备号：不明白
- 链接指针：不明白

<br>
### 树形结构目录

在树形结构目录中，目录应该保存文件的信息。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/48c2c8df-2f08-420a-9ebc-6ced18b6e735" /></div>
同时目录的目录项要能既作为目录文件的FCB，又作为数据文件的FCB。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/3558f5fe-43a4-4902-9f69-a6debd7a99d3" /></div>
<br>
## 文件共享


### 基于有向无循环图实现文件共享


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/063db2c4-3e1a-4042-985a-a4bc2c41e36a" style="width:80%;" /></div>
此种方法存在问题： 
比如对于文件`F8`，`D5:p`、`D6:e`、`D3:p`都保存了`F8`的物理地址，即从某个盘块开始，总长度多少等。此时如果`D6:e`对`F8`进行了删除操作，`D5:p`和`D3:P`都无法察觉，仍然会认为在它们存储的位置上有文件，即一个目录项对文件的操作对其他目录项来说是不可见的。

<br>
### 利用索引节点


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/b49d3d0c-b042-4a62-8f43-40519ca0023b" style="width:60%;" /></div>
引入索引结点，将文件的物理地址和其他的属性放在索引结点中，只在目录项中存放文件名和指向索引结点的指针。由任何用户对文件进行Append操作或修改，引起相应索引结点内容的改变。此种方法即Linux中的硬链接。

<br>
### 利用符号链接实现文件共享

建立符号链接文件，它是一种特殊类型的文件，其内容是被链接文件的路径名。建立符号链接文件，并不影响原文件，实际上它们各是一个文件。可以建立任意的别名关系，甚至原文件是在其他计算机上。只有文件主才有指向索引结点的指针，而其他共享用户只有该文件的路径名。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/dcb09a0e-6f1f-46da-a87b-9a8d3ef5e046" /></div>
<br>
## 文件保护


### 访问权&保护域

- 访问权：一个进程能对某对象执行操作的权利，用<对象名，权集>表示，如`<F1, {R/W}>`表示进程对F1有读和写的权利。
- 保护域：进程对一组对象访问权的集合，进程只能在域内进行操作。

<br>
### 进程和域的联系方式

进程和域之间是一对多的关系，即一个进程可以联系多个域。此时进程的运行分为多个阶段，每个阶段联系一个域，这样就可以根据运行的实际需要规定进程每个阶段所能访问的对象。

<br>
### 访问矩阵


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/bbf7a827-4fa5-4eac-9010-4012650b2ffd" /></div>
- R：在域内运行的进程对文件具有读权限
- W：在域内运行的进程对文件具有写权限
- $R^\ast$：在域内运行的进程能把其对文件的读权限扩展到其他域中，但在其他域中是R权限，不再是$R^\ast$。
- $W^\ast$：在域内运行的进程能把其对文件的写权限扩展到其他域中，但在其他域中是W权限，不再是$W^\ast$。
- S：在域Di中运行的进程能转移到域Dj中运行，如图中在域D3运行的进程能转移到域D2中运行。
- O：在域中运行的进程能增加或删除对某文件的访问权。
- Control：在域Di中运行的进程能删除在域Dj中运行进程对各对象的访问权。如图中在D2中运行的进程能删除在D3中运行进程的访问权。

<br>
### 访问矩阵的实现


**访问控制表**

将访问对象按列划分，为每一列建立一张访问控制表，在该表中把属于对象的所有空项都删除。此时表中的每一项都是一个有序对`<域，权集>`构成。

**访问权限表**

将访问矩阵按行划分，每一行是一个访问权限表，表中的每一项表示该域对某对象的访问权限。
文件管理的目标是管理文件的组织方式，管理文件的访问权等。而磁盘存储器的管理是管理存储器的使用，如何高效利用存储器。他俩是棋与棋盘的关系。

<br>
## 连续组织方式

文件的信息存放在若干连续的物理块中。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/d6f4358a-b197-4d60-a80c-d60b4e096bc8" style="width:70%;"/></div>
- 优点
  - 简单
  - 支持顺序存取和随机存取
  - 顺序存取速度快，所需的磁盘寻道次数和寻道时间最少
- 缺点
  - 文件不能动态增长（预留空间：浪费、重新分配和移动）
  - 不利于文件插入和删除
  - 外部碎片问题

<br>
## 链接组织方式


### 隐式链接

在文件的目录中记录该文件的第一和最后一个盘块的指针，每一个盘块的指针指向文件的下一物理块号。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/3c2e3657-42eb-4d81-9cf4-ea51597deeb9" /></div>
- 优点
  - 文件可动态增长
  - 有利于文件的插入和删除
  - 提高了磁盘空间利用率,不存在外部碎片问题
- 缺点
  - 存取速度慢，不适于随机存取
  - 可靠性问题，如指针出错
  - 更多的寻道次数和寻道时间
  - 链接指针占用一定的空间

<br>
### 显示链接

将链接文件各物理块的指针显示地放在内存的一张链接表（文件分配表，File Allocation Table）中。在FCB的物理地址中填写其首指针所对应的盘块号。由于文件分配表示存储在内存中的，可以大大减少访问磁盘的次数。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/c6a74b5e-0bd6-4213-8fc6-98d18c1e05d3" style="width:70%;" /></div>
<br>
### FAT

微软公司早、中期推出的操作系统一直都是采用的FAT技术，即利用文件分配表FAT来记录每个文件中所有盘块之间的链接。FAT中引入了“卷”的概念，支持将一个物理磁盘分成四个逻辑磁盘，每个逻辑磁盘就是一个卷（也称为分区），每个卷都可以被单独格式化和使用。把盘块作为基本分配单位，同时每个分区中都配有两张相同的文件分配表FAT1和FAT2。
FAT技术的发展有三个阶段：FAT12、FAT16和FAT32

**FAT12**

FAT表的每个表项占用12个bit。所以最多有$2^{12}$个表项，每个盘块的大小是512B，则每个磁盘分区的容量是2MB，能处理的磁盘最大容量是8MB。
为了增大FAT能管理的最大容量，引入了“簇”的概念，每个簇是一组相邻的扇区，这样如果分配时以簇为单位进行分配就能管理更大的磁盘容量，但是相应的簇内零头也会更大，降低磁盘的利用率。

**FAT16**

FAT表的每个表项占用16个bit。最多有$2^{16}$个表项。

**FAT32**

FAT表的每个表项占用32个bit。最多有$2^{32}$个表项。同时每个簇固定为4KB。所以最大可管理$4 \ast 2^{10} \ast 2^{32} = 2TB$大小的空间。

<br>
## 索引组织方式


### 单级索引组织方式

一个文件的信息存放在若干不连续物理块中，系统为每个文件建立一个专用数据结构索引表，并将这些块的块号存放在一个索引表中。一个索引表就是磁盘块地址数组，其中第i个条目指向文件的第i块。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/a1e85fd4-81bc-47e2-a25e-7efd96482df9" style="width:60%;" /></div>·
<br>
###  多级索引组织方式


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/3d242750-4183-4a06-9f11-38d1002c71e8" /></div>
<br>
### 增量式索引组织方式

可以更好的满足大、中、小文件的组织。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/1982b12b-d189-41d1-abf2-024ebfb94ed9" /></div>
<br>
## 文件存储空间的管理

文件存储空间的管理包括空闲块的组织分配和回收。

<br>
###  空闲表法

把一个连续未分配区域称为“空闲文件”，系统为所有空闲文件单独建立一个目录。表目内容：序号，第一个空白块号，空白块个数。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/57c8df64-d3ca-4136-8432-a9da5117dc0f" /></div>
- 分配算法：内存管理中的首次适应算法、循环首次适应算法。
- 合并：空闲区邻接合并

<br>
### 空闲链表法

空闲盘块链：所有空闲盘块拉成一条链，分配时从头分配，回收时链接在尾部。
空闲盘区链：每个连续的盘块组成一个盘区，每个盘区包含本盘区的大小和下一个盘区的地址。

<br>
### 位示图法

用一串二进制位反映磁盘空间中分配使用情况，每个物理块对应一位，分配物理块为1，否则为0。申请物理块时，可以在位示图中查找为0的位，返回对应物理块号；归还时；将对应位转置0。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/d269b94c-777a-4ab3-a839-483808396ace" /></div>
<br>
### 成组链接法（重点）


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/c4490525-02ba-48a7-8662-6ae97c00ece7" /></div>
- 把所有的空闲盘块按每n个一组分成m个组。
- 最后一个组放在内存的空闲盘块号栈中，其他组存在外存上。空闲盘块号栈是一个临界资源，只允许一个进程同时访问。
- 数据结构，一个size为n+1的栈。图上是一个倒着的的栈（栈底在上方，栈顶在下方）
- 一个n+1的栈实际可用盘块只有n（图上只有99个可用盘块），因为栈底是一个计数器，指示当前有多少个可用盘块，但是可用盘块中有一个是指向下一个组，即stack[1]指向下一个组。如果stack[1]==0表示此时是最后一组。
- 分配时从栈顶开始向下分配，直至分配出n-1个盘块，此时如果再想分配一个块就需要把下一个组调入空闲盘块号栈。调入后新组覆盖旧组。**然后把新组在外存中占用的盘块分配出去。**
- 回收时从栈底向上回收，如果计数器==100时还有空闲盘块（设这个盘块编号为p）要回收，就把空闲盘块号栈内的组取出来存在p中，在空闲盘块号栈内新开辟一个组，新组的stack[1]指向p。

#### 例

此题题目及来源：https://blog.csdn.net/ajay666/article/details/73569654

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/fc7e0c9e-a0b5-42ae-a986-7fd6c42c7473" /></div>
分配3个盘块后，回收它所占的5个盘块，回收的盘块号依次为700、711、703、788、701，画出分配回收过程。 

##### 第一次分配


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/2c6b8991-4667-4937-a800-6354c3a2893f" /></div>
##### 第二次分配

注意：300号盘块中存储的组信息调入空闲盘块号栈之后其自己也可以被分配。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/4f6799e5-a774-4141-ae40-30f0bdc4fc03" /></div>
##### 第三次分配


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/8954e673-34e3-422a-94cb-181adf554aef" /></div>
##### 第一次回收


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/9cc9d4da-b64d-46cb-87bb-6c77b94421cf" /></div>
##### 第二次回收


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/7cc820f8-0269-4c40-a50b-cb672cbc7d8a" /></div>
##### 第三次&第四次&第五次回收


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/4043faec-7325-4382-8de2-742f72598ae1" /></div>
