---
title: 06.05-OS-输入输出系统
tags:
  - 操作系统
  - 课内学习
categories:
  - 操作系统
mathjax: true
abbrlink: 3774
date: 2019-12-20 17:19:38
---

<br>
## 概述

输入输出系统和OS中的其他部分有很大区别，因为其他部分都是在说计算机接受任务后该怎么运行能又快又可靠的完成任务并把结果输出。而输入输出系统是怎么快速稳定的将任务的需求输入和任务的结果输出。
又由于输入输出设备种类繁多，比如输入设备中的键盘、鼠标、网卡、摄像头，输出设备中的打印机、音频等。所以输入输出系统被划分很多层次来尽可能屏蔽物理细节。

<br>
### IO系统的基本功能

- 隐藏物理设备的细节：只需要使用简单的命令就能操作各种具有不同实现的硬件完成相应需求。
- 与设备的无关性：用户不需要指定哪些设备完成功能，只需要描述需求，OS会选择一个设备完成功能。
- 提高处理机和IO设备的利用率：IO设备之间一般是相互独立的，因此设备之间能够并行操作，所以OS应让处理机和设备之间能并行操作。
- 对IO设备进行控制：
  - 轮询的可编程IO方式。
  - 采用中断你的可编程IO方式。
  - 直接存储器访问方式。
  - IO通道方式。
- 确保对设备的正确共享。
- 错误处理。

<br>
## IO软件的层次结构


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/933ea414-24d5-4dfd-8201-8cacf6cbeff1" /></div>
- 用户层软件：提供设备与用户交互的接口，用户可以使用该层提供的功能直接控制设备。
- 设备独立性软件：设备分配，设备保护，设备分配，设备回收，数据缓存等。
- 设备驱动软件：发出控制设备的命令。
- 中断处理程序：保存被中断的进程的CPU环境，转入相应的中断处理程序仅需处理，处理完毕后再恢复被中断进程的现场，返回到被中断的进程。

<br>
## IO系统各模块层次视图


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/770f375c-c73f-46e5-828a-bbf0938c241a" /></div>
- 块设备：输入输出以数据块为单位的设备。如磁盘。
- 流设备：字符设备的输入输出，如键盘。
- 网络通信接口：网卡。

<br>
## IO设备和设备控制器

直接和IO设备对接的是设备控制器。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/953ad1c7-eacf-4d86-9a95-87cf7a978c62" /></div>

**作用**

1. 接收和识别命令（控制寄存器、命令译码器）：设备控制器将CPU送来的命令写入控制器寄存器中，并进行译码。
2. 数据交换（数据寄存器）。
3. 设备状态的了解和报告（状态寄存器）。
4. 地址识别（地址译码器）：系统中的每个设备都有自己的地址段，设备接口电路中有多个寄存器，一个寄存器有唯一的一个地址，每个地址为I/O端口，该地址称为I/O端口地址。设备控制器必须能识别每个设备的地址。
5. 数据缓冲：缓冲器。
6. 差错控制：差错检测码。

**组成**

- 设备控制器和处理机的接口：用于实现CPU与设备控制器之间的通信。
- 设备控制器和设备的接口。
- IO逻辑：在一个设备控制器上，可以连一个或多个设备。相应的，在控制器中就有一个或多个设备接口，一个接口连一台设备，控制器中的I/O逻辑根据处理机发来的地址信号，去选择一个设备接口。控制器中的I/O逻辑用来实现对设备的控制。通过接收CPU 发来的命令和地址信息，对所选设备进行控制

<br>
### CPU如何控制设备控制器

CPU控制内存时需要指定指令地址、数据地址等。控制设备控制器亦如此，一般有两种控制方式：
- 利用特定IO指令：利用特殊的IO指令控制设备控制器。
- 内存映像IO：不再区分内存和控制器中的寄存器地址。假如有一个地址K，当0<=K<N时被认为是内存地址，K>=N时被认为是寄存器地址。

<br>
### IO通道

有了设备控制器之后，CPU便可以操作控制器完成对IO设备的控制，但是此时数据交换仍然需要CPU的全程参与，所以引入IO通道来使数据传送、IO设备的组织管理等都独立于CPU。
通道是独立于CPU的专门负责数据输入/输出传输工作的处理机，对外部设备实现统一管理，代替CPU对输入/输出操作进行控制，从而使输入，输出操作可与CPU并行操作。通道执行通道程序来控制IO操作。与CPU的区别：
- 通道程序指令类型单一
- 通道没有自己的内存，通道程序在主机的内存中，即通道与CPU共享内存。

#### 字节多路通道

主要连接以字节为单位的低速IO设备。如打印机，终端。
- 按字节交叉方式工作的通道。通常含有许多非分配型子通道，其数量从几十个到数百个，每一个子通道连接一台I/O设备。这些子通道按时间片轮转方式共享主通道。
- 字节多路通道以字节为单位传输信息，它可以分时地执行多个通道程序。当一个通道程序控制某台设备传送一个字节后，通道硬件就控制转去执行另一个通道程序，控制另一台设备传送信息。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/e84be910-3765-4aaf-9fad-4129b1ac7442" /></div>

#### 数组选择通道

主要连接磁盘，磁带等高速I/O设备
选择通道是按数组方式进行数据传送，每次传送一批数据，故传送速度很高。
选择通道在一段时间内只能执行一个通道程序，只允许一台设备进行数据传输。当这台设备数据传输完成后，再选择与通道连接的另一台设备，执行它的相应的通道程序。这种独占性又使得通道利用率很低。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/bcbc610f-941b-4b1f-b16c-70e915f25f26" /></div>

#### 数组多路通道

主要连接高速设备。
- 结合了数组选择通道传送速度高和字节多路通道能进行分时并行操作的优点。它先为一台设备执行一条通道指令，然后自动转接，为另一台设备执行一条通道指令。它含有多个非分配型的子通道，既有很高的数据传输率，又能获得令人满意的通道利用率
- 对通道程序采用多道程序设计的硬件实现
- 可以连接多台高速设备，数据传输按数组方式，一段时间内可以执行多道通道程序

#### 解决瓶颈

通道执行通道程序，向控制器发出命令，并具有向CPU发中断信号的功能。一旦CPU发出指令，启动通道，则通道独立于CPU工作。但是，由于通道价格贵，通道数量少，往往使之成为IO的“瓶颈”。解决办法是在不增加通道的前提下，增加设备到主机间的通路，一个通道可连接多个控制器，一个控制器可连接多个设备，形成树形交叉连接。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/916c4771-7b35-43bc-8723-c55e7c4c6162" /></div>

<br>
## 中断机构


### 中断的理解

说到中断还不得不从现代操作系统的特性说起，无论是桌面PC操作系统还是嵌入式都是多任务的操作系统，而很遗憾，处理器往往是单个的，即使在硬件成本逐渐下降，但处理器的数量依然不可能做到每个任务一个CPU，所以CPU必须作为一种全局的资源让所有任务共享。即什么时候给任务A用，什么时候给任务B用……这就是进程调度，具体的安排就由调度算法决定了。
进程如何去调度？现代操作系统一般都是采用基于时间片的优先级调度算法，把CPU的时间划分为很细粒度的时间片，一个任务每次只能时间这么多的时间，时间到了就必须交出使用权，即换其他的任务使用。这种要看操作系统的定时器机制了。那么时间片到之后，系统做了什么呢？这就要用到我们的中断了，时间片到了由定时器触发一个软中断，然后进入相应的处理历程。当然这一点不足以表明中断的重要，计算机操作系统自然离不开外部设备：鼠标、键盘、网卡、磁盘等等。就拿网卡来讲，我计算机并不知道时候数据包会来到，我能保证的就是数据来了我能正常接收就行了。但是我又不可能一直等着接收数据包，要是这样其他任务就死完了。所以合理的办法是，你数据包来到之后，通知我，然后我再对你处理，怎么通知呢？？答：中断！键盘、鼠标亦是如此！

<br>
### 中断的定义

指处理机处理程序运行中出现的紧急事件的整个过程。程序运行过程中，系统外部、系统内部或者现行程序本身若出现紧急事件，处理机立即中止现行程序的运行，自动转入相应的处理程序（中断服务程序），待处理完后，再返回原来的程序运行，这整个过程称为程序中断。可分为两类：

#### 硬中断（Hardware Interrupt）

- 外部中断：一般是指由计算机外设发出的中断请求，如：键盘中断、打印机中断、定时器中断等。外部中断是可屏蔽的。
- 内部中断是指因硬件出错（如突然掉电、奇偶校验错等）,或运算出错（除数为零、运算溢出、单步中断等）所引起的中断，内部中断是不可屏蔽的。

#### 软中断（Software Interrupt）

软中断是利用硬中断的概念，用软件方式进行模拟，实现宏观上的异步执行效果。很多情况下，软中断和”信号”有些类似，同时，软中断又是和硬中断相对应的，硬中断是外部设备对CPU的中断，软中断通常是硬中断服务程序（模拟硬件发出中断的程序）对内核的中断，信号则是由内核（或其他进程）对某个进程的中断。

<br>
### 时钟中断

在Linux的0号中断是一个定时器中断。在固定的时间间隔都发生一次中断，也是说每秒发生该中断的频率都是固定的。该频率是常量HZ，该值一般是在100 ~ 1000之间。该中断的作用是为了定时更新系统日期和时间，使系统时间不断地得到跳转。另外该中断的中断处理函数除了更新系统时间外，还需要更新本地CPU统计数。若进程的时间片递减到0，进程则被调度出去而放弃CPU使用权。
Linux的OS时钟的物理产生原因是可编程定时/计数器产生的输出脉冲，这个脉冲送入CPU，就可以引发一个中断请求信号，我们就把它叫做`时钟中断`。
`时钟中断`是特别重要的一个中断，因为整个操作系统的活动都受到它的激励。系统利用时钟中断维持系统时间、促使环境的切换，以保证所有进程共享CPU；利用时钟中断进行记帐、监督系统工作以及确定未来的调度优先级等工作。可以说，`时钟中断`是整个操作系统的脉搏。

<br>
## 设备驱动程序


### 功能

1. 接受设备独立性软件发来的命令和参数，将接收到的抽象要求转换为具体要求
2. 检查用户IO请求的合法性，了解IO设备的状态，传递有关参数，设置设备的工作方式
3. 发出IO命令，如果设备空闲，启动IO设备完成指定的IO操作；如果设备忙碌，则将请求挂在设备队列上等待
4. 及时响应由控制器或通道发来的中断请求，并根据其中断类型调用相应的中断处理程序进行处理。
5. 对于设置有通道的计算机系统，驱动程序还应能够根据用户的IO请求，自动地构成通道程序。

<br>
### 特点

1. 驱动程序主要是在设备无关性软件和设备控制器之间的一个通信程序
2. 驱动程序与IO设备特性密切相关：通常由硬件厂商提供
3. 驱动程序与I/O控制方式密切相关:中断驱动和DMA方式
4. 驱动程序与硬件相关,部分代码需用汇编语言编写
5. 驱动程序应允许可重入

<br>
### 处理过程

1. 将抽象要求转换为具体要求
   1. 通常设备控制器中都有若干个寄存器，分别用于暂存命令、数据和参数等；
   2. 用户及上层软件对设备控制器的具体情况毫无了解，因而只能向它们发出抽象的要求(命令)，但不能直接传送给设备控制器。需要将抽象要求转换为具体要求(命令码，数据，参数)。例如，将抽象要求中的盘块号转换为磁盘的盘面、磁道号及扇区。这一转换工作只能由驱动程序来完成；
   3. 在OS中只有驱动程序才同时了解抽象要求和设备控制器中的寄存器情况；也只有它才知道命令、数据和参数应分别送往哪个寄存器。
2. 检查IO请求的合法性
3. 读出和检查设备的状态
4. 传送必要的参数，设置工作方式
5. 启动I/O设备
   1. 在完成上述准备工作后，驱动程序可以向控制器中的命令寄存器传送相应的控制命令
   2. 对于字符设备，若发出的是写命令，驱动程序将把一个数据传送给控制器；若发出的是读命令，则驱动程序等待接收数据，并通过从控制器中的状态寄存器读入状态字的方法，来确定数据是否到达。
   3. 驱动程序发出IO命令后，基本的IO是在设备控制器的控制下进行的，通常IO操作所要完成的工作较多，需要一定的时间，如读/写一个盘块中的数据，此时，驱动程序进程把自己阻塞起来，直至中断到来时才将它唤醒。

<br>
### 对IO设备的控制方式


#### 使用轮询的可编程I/O方式

CPU发出启动外设的I/O指令，同时将忙/闲标志置为1。如果外设的工作没有完成，则标志一直为1，CPU不断循环检测该标志，直到标志为不忙为止。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/71de03d5-8111-44f5-96fa-15ee82e189c0" /></div>

#### 使用中断的可编程I/O方式

CPU设定I/O设备的初始值，然后不再忙等待，运行其他进程，当前进程阻塞；I/O设备完成对当前数据的处理后，向CPU发出中断，I/O中断处理程序将负责传送剩余数据。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/5019de9a-b7c9-4eeb-a0a9-d00882dbd3ea" /></div>

#### 直接存储器访问(DMA)方式

采用中断驱动IO方式时的CPU，是以字为单位进行干预的。如果将这种方式用于块设备的I／O，是极其低效的。如：为了从磁盘中读出1KB的数据块；需要中断1K次CPU。而DMA方式使用独立的DMA控制器代替CPU的工作，I/O设备与DMA通信，DMA在传输完成一个数据缓冲区之后再向CPU发中断。
- 数据传输的基本单位是数据块，即CPU与IO设备之间，每次传送至少是一个数据块，主要用在块设备的IO操作中。
- 在DMA方式中，利用总线直接连接外设和内存，由DMA控制机构窃取总线占有权，完成外设与内存间的成批数据交换。所传送的数据是从设备直接送入内存的，或者相反。
- 仅在传送一个或多个数据块的开始和结束时，才需CPU干预，整块数据的传送是在控制器的控制下完成的，不再需要CPU进行干预。

#### I/O通道控制方式

使用DMA方式，CPU每发出一条I/O指令，只能读写一个连续的数据块。如果需要一次去读多个离散的数据块且将它们分别送到不同的内存区域，则需要CPU分别发出多条I/O指令及进行多次中断处理，才能完成。
而IO通道可实现CPU、通道和I/O设备三者的并行操作，进一步提高CPU与外设之间的并行工作能力，使I/O操作形成独立于CPU的体系，减少CPU的负担，使外设与内存的数据交换更加灵活，从而更有效地提高整个系统的资源利用率。

<br>
## 与设备无关的I/O软件

为了便于对外设进行管理，系统对每台进入计算机系统中的设备都给定一个对应的编号，作为调用时识别和区分设备用。这种编号无任何重复，一般被称为设备的绝对号（或物理设备名）。早期操作系统，应用程序直接使用物理设备名称，非常不灵活。所以引入逻辑设备名，规定用户申请外设时，只需要向系统说明所需用的某类设备真正在实际中使用哪台设备，由系统根据这类设备的应用情况作出分配。

<br>
### 设备分配

在多道程序环境下，设备不允许用户自行使用，而必须由系统分配。对于进程的IO请求，只要是安全（无死锁），设备分配程序便按照一定的策略进行设备分配。数据结构：

**系统设备表SDT（System Device Table）**

- 整个系统中只有一张，全面反映了系统中的外设资源的类型、数量、占用情况等。
- 在SDT表中，每个接入系统中的外围设备都占有一个表目项。登录了该设备的名称、标识、设备控制表DCT的入口地址、设备驱动程序的入口地址及占用设备的进程名称等相关信息。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/539d5402-4cc5-490c-985c-fad795ce64ac" /></div>

**设备控制表DCT（Device Control Table）**

每台设备都有一张设备控制表DCT，用于记录本设备的情况。
- Type：设备类型
- Deviceid:设备标识符
- 设备队列队首指针
- 设备状态：标识设备忙或者空闲；
- 与设备连接的控制器表指针。
- 重复执行次数

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/2c6655c2-822f-4ab3-9687-fcd81f033f9d" /></div>

**控制器控制表COCT（Controller Control Table）**

每个控制器都有一张，用于记录某控制器的使用分配情况及与该控制器相连的通道的情况。
- 控制器号：控制器的内部标识符。
- 控制器状态：控制器忙/闲，好/坏的状态标志。
- 通道指针：指向与该控制器相联的通道控制表CHCT，当控制器与若干通道连接时该项内含多个指针。
- 等待队列指针：指向等待该控制器的I/O进程队列

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/5a78bf33-edc8-44fa-a002-b0353ed26c29" /></div>

**通道控制表CHCT（Channel Control Table）**

反映了通道的情况，系统中的每个通道一张CHCT。
- 通道号：通道内部标识符
- 通道状态：通道的各种状态（好/坏，已分/未分等）的反映
- 等待队列指针：等待该通道的I/O进程队列的首位置

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/bace2576-4035-437b-a4ac-30414ffea488" /></div>

<br>
### 设备分配算法


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/6b9fe6d2-8133-4526-82a3-08a24238ae27" /></div>

<br>
## 用户层的I/O软件


### 系统调用与库函数

用户层软件必须使用一组系统调用来取得操作系统服务，在高级语言中都提供了相应的库函数来完成此功能。

<br>
### SPOOLing程序

多道程序技术将一台CPU虚拟为多台CPU，从而可以提高CPU的利用率。而SPOOLing系统是模拟脱机输入输出系统来实现多个用户共享一台物理IO设备。
- 脱机输入输出系统的IO处理机   对应   SPOOLing程序。
- 脱机输入输出系统的高速缓冲   对应    内存。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/e7324c67-1eb4-4616-a966-8e8b29021a1e" /></div>

<br>
## 缓冲区


**单缓冲区**


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/92ffc296-47a4-4a11-9bd8-8ab8b45505cc" /></div>

**双缓冲区**

为输入或输出分配两个缓冲区，让两个缓冲区交替工作，形成并行操作的方式。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/11af4878-bdf2-4196-ae83-b8365f4e09ae" /></div>

**环形缓冲区**

- 空缓冲区R：用于存放数据（指针：Nexti）
- 已装满数据的缓冲区G：其中的数据提供给进程使用。（指针：Nextg）
- 现行工作缓冲区C：当前进程使用的缓冲区。（指针：Current）

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/7da390f7-d59f-4fb1-8ce8-f5eac19bd508" /></div>

<br>
## 磁盘存储器的性能和调度


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/fcb16fbb-dee2-4438-ae5c-070fa08106e0" /></div>
当磁盘驱动器执行读/写功能时。盘片装在一个主轴上，并绕主轴高速旋转，当磁道在读/写头（又叫磁头）下通过，就可以进行数据的读/写了。
一般磁盘分为固定头盘（磁头固定）和活动头盘。固定头盘的每一个磁道上都有独立的磁头，它是固定不动的，专门负责这一磁道上数据的读/写。
活动头盘 （如上图）的磁头是可移动的。每一个盘面上只有一个磁头（磁头是双向的，因此正反盘面都能读写）。它可以从该面的一个磁道移动到另一个磁道。所有磁头都装在同一个动臂上，因此不同盘面上的所有磁头都是同时移动的（行动整齐划一）。当盘片绕主轴旋转的时候，磁头与旋转的盘片形成一个圆柱体。各个盘面上半径相同的磁道组成了一个圆柱面，我们称为柱面 。因此，柱面的个数也就是盘面上的磁道数。 

<br>
### 磁盘访问时间

1. 寻道时间$T_s$：$T_s = s$
2. 旋转延迟时间$T_τ$：$T_t =  \frac{1}{2r}$
3. 磁盘访问时间 ：$T_t=\frac{b}{rN}$
$s$是指磁头从当前位置定位到开始点的时间，$b$是传输的字节数，$r$是每秒的转数，$N$是一条磁道上的字节数。$总时间 = T_s + \frac{1}{2r} + \frac{b}{rN}$

<br>
### 磁盘调度算法

假设磁盘访问序列：98，183，37，122，14，124，65，67，读写头起始位置：53。

#### 先来先服务

按访问请求到达的先后次序服务。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/3d7fcac5-9594-490a-8922-5591670a9fe7" /></div>

#### 最短寻道时间优先


<div align='center'><img src="http://blogfileqiniu.isjinhao.site/4f6b90ae-cda1-4121-a194-e5d05c399f1e"/></div>

#### 扫描算法

当设备无访问请求时，磁头不动；当有访问请求时，磁头按一个方向移动，在移动过程中对遇到的访问请求进行服务，然后判断该方向上是否还有访问请求，如果有则继续扫描；否则改变移动方向，并为经过的访问请求服务，如此反复。

<div align='center'><img src="http://blogfileqiniu.isjinhao.site/5d8e546a-f8a3-4325-b885-2888c59c10ac" /></div>

#### 循环扫描算法

CSCAN算法规定磁头单向移动，例如由里向外移动，当磁头移到最外的磁道并访问后磁头立即返回到最里的欲访
问磁道，即最小磁道号紧接最大磁道号构成循环，进行循环扫描。
